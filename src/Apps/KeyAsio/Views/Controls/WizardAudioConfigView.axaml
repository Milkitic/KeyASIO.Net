<UserControl
  x:Class="KeyAsio.Views.Controls.WizardAudioConfigView"
  xmlns="https://github.com/avaloniaui"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:controls="using:KeyAsio.Views.Controls"
  xmlns:lang="clr-namespace:KeyAsio.Lang"
  xmlns:materialIcons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
  xmlns:suki="https://github.com/kikipoulet/SukiUI"
  xmlns:vm="using:KeyAsio.ViewModels"
  x:DataType="vm:WizardAudioConfigViewModel">

  <Grid>
    <Grid
      VerticalAlignment="Center"
      IsVisible="{Binding IsSelectionMode}"
      RowDefinitions="Auto,Auto"
      RowSpacing="20">
      <TextBlock
        Grid.Row="0"
        HorizontalAlignment="Center"
        Classes="h3"
        Text="选择音频工作模式" />
      <Grid
        Grid.Row="1"
        ColumnDefinitions="*,*"
        ColumnSpacing="20">
        <Grid Grid.Column="0">
          <suki:GlassCard Command="{Binding SelectModeCommand}" IsInteractive="True">
            <suki:GlassCard.CommandParameter>
              <vm:WizardMode>Hardware</vm:WizardMode>
            </suki:GlassCard.CommandParameter>
            <StackPanel VerticalAlignment="Center" Spacing="15">
              <StackPanel
                HorizontalAlignment="Center"
                Orientation="Vertical"
                Spacing="10">
                <materialIcons:MaterialIcon
                  Width="64"
                  Height="64"
                  Foreground="{DynamicResource SukiPrimaryColor}"
                  Kind="DeveloperBoard" />
                <TextBlock
                  FontSize="18"
                  FontWeight="Bold"
                  Text="专业设备 / 支持独占并发"
                  TextAlignment="Center"
                  TextWrapping="Wrap" />
              </StackPanel>

              <TextBlock
                Height="100"
                Opacity="0.7"
                Text="我有独立声卡，或者我的设备支持 ASIO/WASAPI 独占且不影响系统声音。"
                TextAlignment="Center"
                TextWrapping="Wrap" />
            </StackPanel>
          </suki:GlassCard>
        </Grid>

        <Grid Grid.Column="1">
          <suki:GlassCard Command="{Binding SelectModeCommand}" IsInteractive="True">
            <suki:GlassCard.CommandParameter>
              <vm:WizardMode>Software</vm:WizardMode>
            </suki:GlassCard.CommandParameter>
            <StackPanel Spacing="15">
              <StackPanel
                HorizontalAlignment="Center"
                Orientation="Vertical"
                Spacing="10">
                <materialIcons:MaterialIcon
                  Width="64"
                  Height="64"
                  Foreground="{DynamicResource SukiPrimaryColor}"
                  Kind="SurroundSound51" />
                <TextBlock
                  FontSize="18"
                  FontWeight="Bold"
                  Text="普通用户 / 使用板载声卡"
                  TextAlignment="Center"
                  TextWrapping="Wrap" />
              </StackPanel>

              <StackPanel Height="100" Spacing="15">
                <TextBlock
                  Opacity="0.7"
                  Text="我只有一个声卡（如笔记本内置），或者我不确定。 (推荐)"
                  TextAlignment="Center"
                  TextWrapping="Wrap" />
                <Border
                  Padding="10,5"
                  HorizontalAlignment="Center"
                  Background="{DynamicResource SukiPrimaryColor}"
                  CornerRadius="5">
                  <TextBlock
                    FontSize="12"
                    Foreground="White"
                    Text="包含 ProMix 试用权益" />
                </Border>
              </StackPanel>
            </StackPanel>
          </suki:GlassCard>
        </Grid>
      </Grid>
    </Grid>

    <!--  Hardware Config  -->
    <Grid IsVisible="{Binding IsHardwareConfig}">
      <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel
          Width="500"
          HorizontalAlignment="Center"
          VerticalAlignment="Center"
          Spacing="20">
          <TextBlock
            HorizontalAlignment="Center"
            Classes="h3"
            Text="硬件模式配置" />

          <!--  Warning  -->
          <suki:GlassCard Classes="Error" IsVisible="{Binding ShowHardwareDriverWarning}">
            <StackPanel Spacing="10">
              <StackPanel
                VerticalAlignment="Center"
                Orientation="Horizontal"
                Spacing="10">
                <materialIcons:MaterialIcon Foreground="Red" Kind="AlertCircle" />
                <TextBlock
                  VerticalAlignment="Center"
                  Text="{Binding HardwareDriverWarning}"
                  TextWrapping="Wrap" />
              </StackPanel>
              <Button
                HorizontalAlignment="Right"
                Classes="Flat"
                Command="{Binding SelectModeCommand}"
                Content="切换到软件模式">
                <Button.CommandParameter>
                  <vm:WizardMode>Software</vm:WizardMode>
                </Button.CommandParameter>
              </Button>
            </StackPanel>
          </suki:GlassCard>

          <!--  Config  -->
          <suki:GlassCard>
            <StackPanel Spacing="15">
              <controls:SettingItem Header="{I18N {x:Static lang:SRKeys.Wizard_Config_Device}}" Icon="Speaker">
                <ComboBox
                  MinWidth="250"
                  ItemsSource="{Binding AvailableAudioDevices}"
                  SelectedItem="{Binding SelectedAudioDevice}">
                  <ComboBox.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding FriendlyName}" />
                    </DataTemplate>
                  </ComboBox.ItemTemplate>
                </ComboBox>
              </controls:SettingItem>

              <Border
                Padding="10"
                Background="#20000000"
                CornerRadius="8">
                <StackPanel Spacing="5">
                  <TextBlock FontWeight="Bold" Text="注意：" />
                  <TextBlock Text="请在 osu! 中将输出设备改为 [非当前设备] ，并将音效(Effect)音量调至 0" TextWrapping="Wrap" />
                </StackPanel>
              </Border>
            </StackPanel>
          </suki:GlassCard>
        </StackPanel>
      </ScrollViewer>
    </Grid>

    <!--  Software Config  -->
    <Grid IsVisible="{Binding IsSoftwareConfig}">
      <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel
          Width="500"
          HorizontalAlignment="Center"
          VerticalAlignment="Center"
          Spacing="20">
          <TextBlock
            HorizontalAlignment="Center"
            Classes="h3"
            Text="软件 / ProMix 模式配置" />

          <!--  Intro/Check  -->
          <suki:GlassCard>
            <StackPanel Spacing="10">
              <TextBlock FontWeight="Bold" Text="ProMix 权益：低延迟混音、无视独占" />

              <StackPanel
                IsVisible="{Binding IsVirtualDriverDetected}"
                Orientation="Horizontal"
                Spacing="10">
                <materialIcons:MaterialIcon Foreground="Green" Kind="CheckCircle" />
                <TextBlock VerticalAlignment="Center" Text="{I18N {x:Static lang:SRKeys.Wizard_VirtualDriver_Detected}}" />
              </StackPanel>

              <StackPanel IsVisible="{Binding ShowVirtualDriverWarning}" Spacing="10">
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <materialIcons:MaterialIcon Foreground="Orange" Kind="AlertCircle" />
                  <TextBlock VerticalAlignment="Center" Text="{Binding VirtualDriverWarning}" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <Button
                    Classes="Flat"
                    Command="{Binding DownloadVirtualDriverCommand}"
                    Content="下载驱动 (VB-Audio Cable)" />
                  <Button
                    Classes="Flat"
                    Command="{Binding RetryVirtualDriverCheckCommand}"
                    Content="已安装，刷新检测" />
                </StackPanel>
              </StackPanel>
            </StackPanel>
          </suki:GlassCard>

          <!--  Config  -->
          <suki:GlassCard>
            <StackPanel Spacing="15">
              <controls:SettingItem Header="物理输出设备 (耳机/音响)" Icon="Headphones">
                <ComboBox
                  MinWidth="250"
                  ItemsSource="{Binding AvailableAudioDevices}"
                  SelectedItem="{Binding SelectedAudioDevice}">
                  <ComboBox.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding FriendlyName}" />
                    </DataTemplate>
                  </ComboBox.ItemTemplate>
                </ComboBox>
              </controls:SettingItem>

              <Border
                Padding="10"
                Background="#20000000"
                CornerRadius="8">
                <StackPanel Spacing="5">
                  <TextBlock FontWeight="Bold" Text="注意：" />
                  <TextBlock Text="请在 osu! 设置中，将输出设备修改为 [VB-Audio Cable] " TextWrapping="Wrap" />
                </StackPanel>
              </Border>
            </StackPanel>
          </suki:GlassCard>
        </StackPanel>
      </ScrollViewer>
    </Grid>

    <!--  Validation  -->
    <Grid IsVisible="{Binding IsValidationStep}">
      <StackPanel
        HorizontalAlignment="Center"
        VerticalAlignment="Center"
        Spacing="20">
        <TextBlock
          HorizontalAlignment="Center"
          Classes="h3"
          Text="{Binding ValidationMessage}" />

        <suki:Loading IsVisible="{Binding IsValidationRunning}" />

        <materialIcons:MaterialIcon
          Width="60"
          Height="60"
          Foreground="Green"
          IsVisible="{Binding ValidationSuccess}"
          Kind="CheckCircle" />

        <StackPanel IsVisible="{Binding !IsValidationRunning}">
          <StackPanel IsVisible="{Binding !ValidationSuccess}" Spacing="10">
            <materialIcons:MaterialIcon
              Width="60"
              Height="60"
              Foreground="Red"
              Kind="CloseCircle" />
            <Button
              HorizontalAlignment="Center"
              Command="{Binding ApplyAndTestConfigCommand}"
              Content="重试" />
          </StackPanel>

          <StackPanel IsVisible="{Binding ValidationSuccess}" Spacing="10">
            <TextBlock
              HorizontalAlignment="Center"
              Opacity="0.7"
              Text="配置已完成，请按键盘试听，确认无误后点击下一步" />
          </StackPanel>
        </StackPanel>
      </StackPanel>
    </Grid>
  </Grid>
</UserControl>