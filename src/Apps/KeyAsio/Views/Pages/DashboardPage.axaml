<UserControl
  x:Class="KeyAsio.Views.Pages.DashboardPage"
  xmlns="https://github.com/avaloniaui"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:audio="clr-namespace:KeyAsio.Core.Audio;assembly=KeyAsio.Core.Audio"
  xmlns:controls="using:KeyAsio.Views.Controls"
  xmlns:converters="using:KeyAsio.Converters"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:lang="clr-namespace:KeyAsio.Lang"
  xmlns:materialIcons="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:suki="https://github.com/kikipoulet/SukiUI"
  xmlns:vm="using:KeyAsio.ViewModels"
  x:DataType="vm:MainWindowViewModel"
  mc:Ignorable="d">

  <UserControl.Resources>
    <converters:EnumEqualityConverter x:Key="EnumEqualityConverter" />
    <converters:IntMillisecond2TimeSpanConverter x:Key="IntMillisecond2TimeSpanConverter" />
    <converters:HookKeyToDisplayConverter x:Key="HookKeyToDisplayConverter" />
    <converters:OsuStatusToActiveBoolConverter x:Key="OsuStatusToActiveBoolConverter" />

    <LinearGradientBrush x:Key="PremiumGoldBrush" StartPoint="0%,0%" EndPoint="100%,100%">
      <GradientStop Offset="0.0" Color="#FFEDC2" />
      <GradientStop Offset="0.5" Color="#FFD700" />
      <GradientStop Offset="1.0" Color="#D4AF37" />
    </LinearGradientBrush>

    <LinearGradientBrush x:Key="PremiumGoldBorderBrush" StartPoint="0%,0%" EndPoint="100%,100%">
      <GradientStop Offset="0.0" Color="#FFF5E1" />
      <GradientStop Offset="1.0" Color="#C5A028" />
    </LinearGradientBrush>
  </UserControl.Resources>

  <Design.DataContext>
    <vm:MainWindowViewModel />
  </Design.DataContext>

  <Grid Margin="20" RowDefinitions="Auto,*,Auto">

    <!--  Top: Switcher  -->
    <suki:GlassCard
      Margin="0,0,0,15"
      Classes="Surface"
      IsVisible="{Binding AppSettings.Sync.EnableSync}">
      <DockPanel>
        <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
          <controls:DashboardSwitch
            x:Name="MixSwitch"
            HasMixModeTag="{Binding PluginManager.HasMixModeTag}"
            IsChecked="{Binding AppSettings.Sync.EnableMixSync}"
            IsCorrupt="{Binding PluginManager.ActivePlugin, Converter={x:Static ObjectConverters.IsNull}}"
            IsEnabled="{Binding PluginManager.IsMixSwitchEnabled}"
            IsPro="{Binding PluginManager.IsMixModeTagPro}"
            MixModeDisplayName="{Binding PluginManager.MixModeDisplayName}"
            MixModeTag="{Binding PluginManager.MixModeTag}" />
        </StackPanel>
        <StackPanel
          VerticalAlignment="Center"
          Orientation="Horizontal"
          Spacing="10">
          <materialIcons:MaterialIcon Foreground="{DynamicResource SukiPrimaryColor}" Kind="LightningBolt" />
          <TextBlock
            VerticalAlignment="Center"
            FontWeight="DemiBold"
            Text="{I18N {x:Static lang:SRKeys.Audio_EngineStatus}}" />
        </StackPanel>
      </DockPanel>
    </suki:GlassCard>

    <!--  Center: The Core (Sphere visualization)  -->
    <controls:DashboardSphere
      Grid.Row="1"
      IsActive="{Binding SyncDisplay.OsuStatus, Converter={StaticResource OsuStatusToActiveBoolConverter}}"
      IsVisible="{Binding AppSettings.Sync.EnableSync}"
      ProcessId="{Binding SyncDisplay.ProcessId}"
      StatusText="{Binding SyncDisplay.SyncedStatusText}" />

    <!--  Legacy Mode Hint  -->
    <StackPanel
      Grid.Row="1"
      HorizontalAlignment="Center"
      VerticalAlignment="Center"
      IsVisible="{Binding !AppSettings.Sync.EnableSync}"
      Spacing="10">
      <materialIcons:MaterialIcon
        Width="64"
        Height="64"
        Foreground="{DynamicResource SukiPrimaryColor}"
        Kind="Keyboard" />
      <TextBlock
        HorizontalAlignment="Center"
        Classes="h3"
        FontWeight="Bold"
        Text="{I18N {x:Static lang:SRKeys.Settings_LegacyModeKeyOnly}}" />
      <TextBlock
        MaxWidth="500"
        HorizontalAlignment="Center"
        Opacity="0.6"
        Text="{I18N {x:Static lang:SRKeys.Settings_LegacyModeDescription}}"
        TextAlignment="Center"
        TextWrapping="Wrap" />
    </StackPanel>
    <!--
    <CheckBox
      x:Name="CbControlStatus"
      Grid.Row="1"
      HorizontalAlignment="Right"
      Content="IsActive"
      IsCheckedChanged="CbControlStatus_OnIsCheckedChanged" />    -->
    <!--  Bottom: Stats & Quick Keys  -->
    <StackPanel
      Grid.Row="2"
      Margin="0,20,0,0"
      Spacing="15">
      <!--  Sync Info  -->
      <suki:GlassCard Classes="Surface" IsVisible="{Binding AppSettings.Sync.EnableSync}">
        <Grid RowDefinitions="Auto,*">
          <DockPanel LastChildFill="False">
            <TextBlock FontWeight="Bold" Text="{I18N {x:Static lang:SRKeys.Dashboard_SyncStatus}}" />
          </DockPanel>

          <Grid
            Grid.Row="1"
            Margin="0,15,0,0"
            ColumnDefinitions="2*,*,*">
            <StackPanel Margin="0,0,10,0">
              <TextBlock
                Margin="0,0,0,5"
                Classes="Label"
                Text="{I18N {x:Static lang:SRKeys.Dashboard_Beatmap}}" />
              <TextBlock
                FontWeight="DemiBold"
                Text="{Binding SyncDisplay.Beatmap.Filename}"
                TextTrimming="CharacterEllipsis"
                ToolTip.Tip="{Binding SyncDisplay.Beatmap.Filename}" />
            </StackPanel>
            <StackPanel Grid.Column="1" Margin="0,0,10,0">
              <TextBlock
                Margin="0,0,0,5"
                Classes="Label"
                Text="{I18N {x:Static lang:SRKeys.Dashboard_PlayTime}}" />
              <TextBlock
                FontFamily="Consolas"
                FontWeight="DemiBold"
                Text="{Binding SyncDisplay.PlayTime, Converter={StaticResource IntMillisecond2TimeSpanConverter}}" />
            </StackPanel>
            <StackPanel Grid.Column="2">
              <TextBlock
                Margin="0,0,0,5"
                Classes="Label"
                Text="{I18N {x:Static lang:SRKeys.Dashboard_Status}}" />
              <TextBlock FontWeight="DemiBold" Text="{Binding SyncDisplay.OsuStatus}" />
            </StackPanel>
          </Grid>
        </Grid>
      </suki:GlassCard>

      <Grid ColumnDefinitions="*,*">
        <!--  Stats  -->
        <suki:GlassCard
          Height="140"
          Margin="0,0,10,0"
          Padding="15"
          Command="{Binding ShowDeviceErrorCommand}"
          IsInteractive="{Binding AudioSettings.DeviceErrorMessage, Converter={x:Static ObjectConverters.IsNotNull}}">
          <suki:GlassCard.Styles>
            <Style Selector="suki|GlassCard[IsInteractive=True]">
              <Setter Property="Cursor" Value="Hand" />
            </Style>
          </suki:GlassCard.Styles>

          <Grid RowDefinitions="Auto,*">

            <DockPanel LastChildFill="False">
              <StackPanel Orientation="Horizontal" Spacing="10">
                <materialIcons:MaterialIcon Foreground="{DynamicResource SukiPrimaryColor}" Kind="Speaker" />
                <TextBlock
                  VerticalAlignment="Center"
                  FontWeight="Bold"
                  Text="{I18N {x:Static lang:SRKeys.Audio_Device}}" />
                <Panel VerticalAlignment="Center" IsVisible="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription, Converter={x:Static ObjectConverters.IsNotNull}}">
                  <Border
                    Background="{DynamicResource SukiPrimaryColor}"
                    CornerRadius="4"
                    Opacity="0.1" />
                  <TextBlock
                    Margin="6,2"
                    FontSize="10"
                    FontWeight="Bold"
                    Foreground="{DynamicResource SukiPrimaryColor}"
                    Text="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription.WavePlayerType}" />
                </Panel>
              </StackPanel>

              <!--  Action Buttons  -->
              <StackPanel
                DockPanel.Dock="Right"
                Orientation="Horizontal"
                Spacing="5">
                <!--  ASIO Settings  -->
                <Button
                  Classes="IconAction Flat"
                  Command="{Binding AudioSettings.OpenAsioPanelCommand}"
                  IsVisible="{Binding AudioSettings.IsAsio}"
                  ToolTip.Tip="{I18N {x:Static lang:SRKeys.Audio_DriverPanel}}">
                  <materialIcons:MaterialIcon
                    Width="16"
                    Height="16"
                    Kind="Tune"
                    Opacity="0.7" />
                </Button>

                <!--  Refresh  -->
                <Button
                  Classes="IconAction"
                  Command="{Binding AudioSettings.ReloadAudioDeviceCommand}"
                  Cursor="Arrow"
                  IsVisible="{Binding AppSettings.Audio.PlaybackDevice, Converter={x:Static ObjectConverters.IsNotNull}}"
                  ToolTip.Tip="{I18N {x:Static lang:SRKeys.Audio_ReloadDevice}}">
                  <materialIcons:MaterialIcon
                    Width="16"
                    Height="16"
                    Kind="Refresh"
                    Opacity="0.7" />
                </Button>

                <!--  Delete/Clear  -->
                <Button
                  Classes="IconAction Danger"
                  Command="{Binding AudioSettings.ClearAudioDeviceCommand}"
                  Cursor="Arrow"
                  IsVisible="{Binding AppSettings.Audio.PlaybackDevice, Converter={x:Static ObjectConverters.IsNotNull}}"
                  ToolTip.Tip="{I18N {x:Static lang:SRKeys.Audio_ClearDevice}}">
                  <materialIcons:MaterialIcon
                    Width="16"
                    Height="16"
                    Kind="Close"
                    Opacity="0.7" />
                </Button>
              </StackPanel>
            </DockPanel>

            <Panel Grid.Row="1" VerticalAlignment="Stretch">
              <!--  No Device  -->
              <StackPanel VerticalAlignment="Center" IsVisible="{Binding AppSettings.Audio.PlaybackDevice, Converter={x:Static ObjectConverters.IsNull}}">
                <TextBlock Foreground="{DynamicResource SukiText}" Text="{I18N {x:Static lang:SRKeys.Audio_NoDeviceSelected}}" />
                <HyperlinkButton Command="{Binding NavigateToAudioEngineCommand}">
                  <StackPanel Orientation="Horizontal" Spacing="2">
                    <TextBlock Text="{I18N {x:Static lang:SRKeys.Common_GoToSettings}}" />
                    <materialIcons:MaterialIcon
                      Width="16"
                      Height="16"
                      Kind="ArrowTopRight" />
                  </StackPanel>
                </HyperlinkButton>
              </StackPanel>

              <!--  Device Fault  -->
              <Border
                Padding="0"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Center"
                Classes="Basic"
                IsVisible="{Binding AudioSettings.DeviceErrorMessage, Converter={x:Static ObjectConverters.IsNotNull}}">
                <StackPanel>
                  <TextBlock
                    FontSize="15"
                    FontWeight="Bold"
                    Foreground="{DynamicResource SukiDangerColor}"
                    TextWrapping="Wrap">
                    <materialIcons:MaterialIcon
                      Width="12"
                      Height="12"
                      Foreground="{DynamicResource SukiDangerColor}"
                      Kind="AlertCircle" />
                    <Run Text="{Binding AudioSettings.DeviceErrorMessage}" /></TextBlock>
                  <TextBlock Foreground="{DynamicResource SukiDangerColor}" TextTrimming="CharacterEllipsis">
                    <Run Text="{Binding AppSettings.Audio.PlaybackDevice.FriendlyName}" /><Run Text=" (" /><Run Text="{Binding AppSettings.Audio.PlaybackDevice.WavePlayerType}" /><Run Text=")" />
                  </TextBlock>
                </StackPanel>
              </Border>

              <!--  Device Info  -->
              <Grid
                VerticalAlignment="Center"
                IsVisible="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription, Converter={x:Static ObjectConverters.IsNotNull}}"
                RowDefinitions="Auto,*">

                <TextBlock
                  Margin="0,10"
                  FontSize="15"
                  FontWeight="DemiBold"
                  Text="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription.FriendlyName}"
                  TextWrapping="Wrap" />

                <WrapPanel Grid.Row="1" Orientation="Horizontal">
                  <!--  Sample Rate  -->
                  <controls:StatBadge
                    Margin="0,0,10,0"
                    Label="{I18N {x:Static lang:SRKeys.Audio_SampleRate}}"
                    Value="{Binding AudioSettings.AudioEngine.EngineWaveFormat.SampleRate, StringFormat='{}{0} Hz', FallbackValue='-'}" />

                  <!--  Latency (WASAPI)  -->
                  <controls:StatBadge
                    Margin="0,0,10,0"
                    IsVisible="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription.WavePlayerType, Converter={StaticResource EnumEqualityConverter}, ConverterParameter={x:Static audio:WavePlayerType.WASAPI}}"
                    Label="{I18N {x:Static lang:SRKeys.Audio_Latency}}"
                    Value="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription.Latency, StringFormat='{}{0} ms'}" />

                  <!--  Latency (DirectSound)  -->
                  <controls:StatBadge
                    Margin="0,0,10,0"
                    IsVisible="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription.WavePlayerType, Converter={StaticResource EnumEqualityConverter}, ConverterParameter={x:Static audio:WavePlayerType.DirectSound}}"
                    Label="{I18N {x:Static lang:SRKeys.Audio_Latency}}"
                    Value="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription.Latency, StringFormat='{}{0} ms'}" />

                  <!--  ASIO Buffer  -->
                  <controls:StatBadge
                    Margin="0,0,10,0"
                    IsVisible="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription.WavePlayerType, Converter={StaticResource EnumEqualityConverter}, ConverterParameter={x:Static audio:WavePlayerType.ASIO}}"
                    Label="{I18N {x:Static lang:SRKeys.Audio_Buffer}}"
                    Value="{Binding AudioSettings.FramesPerBuffer, StringFormat='{}{0} samples'}" />

                  <!--  ASIO Latency  -->
                  <controls:StatBadge
                    Margin="0,0,10,0"
                    IsVisible="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription.WavePlayerType, Converter={StaticResource EnumEqualityConverter}, ConverterParameter={x:Static audio:WavePlayerType.ASIO}}"
                    Label="{I18N {x:Static lang:SRKeys.Audio_Latency}}"
                    Value="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription.AsioLatencyMs, StringFormat='{}{0:F2} ms'}" />

                  <!--  Exclusive Mode  -->
                  <controls:StatBadge
                    Margin="0,0,10,0"
                    IsVisible="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription.WavePlayerType, Converter={StaticResource EnumEqualityConverter}, ConverterParameter={x:Static audio:WavePlayerType.WASAPI}}"
                    Label="{I18N {x:Static lang:SRKeys.Audio_Exclusive}}">
                    <controls:StatBadge.Value>
                      <Panel>
                        <TextBlock
                          FontWeight="DemiBold"
                          Foreground="{DynamicResource SukiPrimaryColor}"
                          IsVisible="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription.IsExclusive}"
                          Text="{I18N {x:Static lang:SRKeys.Common_On}}" />
                        <TextBlock
                          FontWeight="DemiBold"
                          IsVisible="{Binding AudioSettings.AudioEngine.CurrentDeviceDescription.IsExclusive, Converter={x:Static BoolConverters.Not}}"
                          Opacity="0.5"
                          Text="{I18N {x:Static lang:SRKeys.Common_Off}}" />
                      </Panel>
                    </controls:StatBadge.Value>
                  </controls:StatBadge>

                </WrapPanel>
              </Grid>
            </Panel>
          </Grid>
        </suki:GlassCard>

        <!--  Key Bindings  -->
        <suki:GlassCard
          Grid.Column="1"
          Margin="10,0,0,0"
          Padding="15">
          <Grid RowDefinitions="Auto,*">
            <DockPanel LastChildFill="False">
              <TextBlock FontWeight="Bold" Text="{I18N {x:Static lang:SRKeys.Dashboard_QuickBindings}}" />

              <!--  Add Button  -->
              <Button
                Margin="5,0,0,0"
                Classes="IconAction Flat"
                Command="{Binding KeyBinding.AddKeyCommand}"
                DockPanel.Dock="Right"
                IsVisible="{Binding !KeyBinding.IsEditingKeys}">
                <materialIcons:MaterialIcon Kind="Plus" />
              </Button>

              <!--  Edit/Done Toggle  -->
              <Panel DockPanel.Dock="Right">
                <Button
                  Classes="IconAction Flat"
                  Command="{Binding KeyBinding.ToggleEditKeysCommand}"
                  IsVisible="{Binding !KeyBinding.IsEditingKeys}"
                  ToolTip.Tip="{I18N {x:Static lang:SRKeys.Dashboard_EditBindings}}">
                  <materialIcons:MaterialIcon Kind="Pencil" />
                </Button>
                <Button
                  Classes="IconAction Flat"
                  Command="{Binding KeyBinding.ToggleEditKeysCommand}"
                  IsVisible="{Binding KeyBinding.IsEditingKeys}"
                  ToolTip.Tip="{I18N {x:Static lang:SRKeys.Common_Done}}">
                  <materialIcons:MaterialIcon Kind="Check" />
                </Button>
              </Panel>
            </DockPanel>

            <ScrollViewer
              Grid.Row="1"
              Margin="0,10,0,0"
              HorizontalScrollBarVisibility="Auto"
              VerticalScrollBarVisibility="Disabled">
              <ItemsControl ItemsSource="{Binding KeyBinding.BoundKeys}">
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <StackPanel
                      HorizontalAlignment="Left"
                      Orientation="Horizontal"
                      Spacing="10" />
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Canvas Width="42" Height="42">
                      <suki:GlassCard
                        Width="42"
                        Height="42"
                        Padding="0"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        CornerRadius="8">
                        <ContentControl
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          Content="{Binding Converter={StaticResource HookKeyToDisplayConverter}}"
                          FontSize="16"
                          FontWeight="Bold" />
                      </suki:GlassCard>

                      <Button
                        Canvas.Top="-8"
                        Canvas.Right="-8"
                        Width="20"
                        Height="20"
                        Margin="0,0,0,0"
                        Padding="0"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Top"
                        Classes="Danger"
                        Command="{Binding $parent[UserControl].DataContext.KeyBinding.RemoveKeyCommand}"
                        CommandParameter="{Binding}"
                        CornerRadius="10"
                        IsVisible="{Binding $parent[UserControl].DataContext.KeyBinding.IsEditingKeys}">
                        <materialIcons:MaterialIcon
                          Width="12"
                          Height="12"
                          Kind="Close" />
                      </Button>
                    </Canvas>

                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </ScrollViewer>
          </Grid>
        </suki:GlassCard>
      </Grid>
    </StackPanel>
  </Grid>
</UserControl>
